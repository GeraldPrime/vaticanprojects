{% extends 'user/base.html' %}

{% block title %}Property Sale Detail{% endblock %}
{% load humanize %}

{% block body %}

<div class="content-page">
    <div class="content">
        <div class="container-fluid mt-4">

        <!-- Sale Header -->
        <div class="row mb-3">
            <div class="col">
            <h2>Sale {{ sale.reference_number }}</h2>
            <p class="text-muted">Created on {{ sale.created_at|date:"M d, Y" }}</p>
            </div>
        </div>

        <!-- Payment Status Alert -->
        <div class="row mb-3">
            <div class="col">
                {% if balance_due <= 0 %}
                    <div class="alert alert-success">
                        <strong>Fully Paid!</strong> This property has been completely paid for.
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <strong>Partially Paid!</strong> Remaining Balance: ₦{{ balance_due|floatformat:2|intcomma }}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Basic Sale Info -->
        <div class="row mb-4">
            <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                <strong>Property Details</strong>
                </div>
                <div class="card-body">
                <p><strong>Estate:</strong> {{ sale.property_item.name }}</p>
                <p><strong>Type:</strong> {{ sale.get_property_type_display }}</p>
                <p><strong>Quantity:</strong> {{ sale.quantity }}</p>
                <p><strong>Plan:</strong> {{ sale.get_payment_plan_display }}</p>
                </div>
            </div>
            <div class="card mb-3">
                <div class="card-header">
                <strong>Client Information</strong>
                </div>
                <div class="card-body">
                <p><strong>Name:</strong> {{ sale.client_name }}</p>
                <p><strong>Address:</strong> {{ sale.client_address }}</p>
                <p><strong>Phone:</strong> {{ sale.client_phone }}</p>
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                <strong>Next of Kin</strong>
                </div>
                <div class="card-body">
                <p><strong>Name:</strong> {{ sale.next_of_kin_name }}</p>
                <p><strong>Address:</strong> {{ sale.next_of_kin_address }}</p>
                <p><strong>Phone:</strong> {{ sale.next_of_kin_phone }}</p>
                </div>
            </div>
            </div>

            <!-- Financial & Realtor Info -->
            <div class="col-md-6">
            <div class="card mb-3">
                <div class="card-header">
                <strong>Financials</strong>
                </div>
                <div class="card-body">
                <p><strong>Original Price:</strong> ₦{{ sale.original_price|floatformat:2 }}</p>
                <p><strong>Selling Price:</strong> ₦{{ sale.selling_price|floatformat:2 }}</p>
                <p><strong>Amount Paid:</strong> ₦{{ sale.amount_paid|floatformat:2 }}</p>
                <p><strong>Balance Due:</strong> <span class="{% if sale.balance_due > 0 %}text-danger{% else %}text-success{% endif %}">₦{{ sale.balance_due|floatformat:2|intcomma }}</span></p>
               
                <!-- Inside your “Financials” card: -->
                <div class="progress mt-2">
                    <div class="progress-bar bg-success"
                        role="progressbar"
                        style="width: {{ payment_progress_percent|floatformat:0 }}%;"
                        aria-valuenow="{{ payment_progress_percent|floatformat:0 }}"
                        aria-valuemin="0"
                        aria-valuemax="100">
                    {{ payment_progress_percent|floatformat:0 }}%
                    </div>
                </div>
  
                </div>
            </div>
            <div class="card">
                <div class="card-header">
                <strong>Realtor & Commission Codes</strong>
                </div>
                <div class="card-body">
                <p><strong>Realtor:</strong> {{ sale.realtor.full_name }}</p>
                <p><strong>Referral Code:</strong> {{ sale.realtor.referral_code }}</p>
                {% if sale.realtor.sponsor %}
                    <p><strong>Sponsor:</strong> {{ sale.realtor.sponsor.full_name }}</p>
                    <p><strong>Sponsor's Code:</strong> {{ sale.realtor.sponsor.referral_code }}</p>
                {% endif %}
                </div>
            </div>
            </div>
        </div>

        <!-- Commission Breakdown -->
        <div class="row mb-4">
            <div class="col">
            <div class="card bg-light">
                <div class="card-header">
                <strong>Commission Breakdown</strong>
                </div>
                <div class="card-body">
                <p>
                    ₦{{ sale.amount_paid|floatformat:2 }}
                    &times; {{ sale.realtor_commission_percentage }}%
                    = <strong>₦{{ realtor_commission|floatformat:2 }}</strong>
                    <br><small>(Realtor's share)</small>
                </p>
                {% if sale.realtor.sponsor %}
                <p>
                    ₦{{ sale.amount_paid|floatformat:2 }}
                    &times; {{ sale.sponsor_commission_percentage }}%
                    = <strong>₦{{ sponsor_commission|floatformat:2 }}</strong>
                    <br><small>(Sponsor's share)</small>
                </p>
                {% endif %}
                {% if sale.realtor.sponsor and sale.realtor.sponsor.sponsor %}
                <p>
                    ₦{{ sale.amount_paid|floatformat:2 }}
                    &times; {{ sale.upline_commission_percentage }}%
                    = <strong>₦{{ upline_commission|floatformat:2 }}</strong>
                    <br><small>(Upline's share)</small>
                </p>
                {% endif %}
                </div>
            </div>
            </div>
        </div>

        <!-- Payments List -->
        <div class="row mb-4">
            <div class="col">
            <div class="card">
                <div class="card-header">
                <strong>Payments</strong>
                </div>
                <div class="card-body p-0">
                {% if payments %}
                <table class="table mb-0">
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount (₦)</th>
                        <th>Method</th>
                        <th>Reference</th>
                        <th>Notes</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for pay in payments %}
                    <tr>
                        <td>{{ pay.payment_date|date:"M d, Y H:i" }}</td>
                        <td>{{ pay.amount|floatformat:2|intcomma }}</td>
                        <td>{{ pay.payment_method }}</td>
                        <td>{{ pay.reference }}</td>
                        <td>{{ pay.notes }}</td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
                {% else %}
                    <p class="p-3 text-muted">No payments recorded yet.</p>
                {% endif %}
                </div>
            </div>
            </div>
        </div>

        <!-- New Payment Form -->
        <div class="row">
            <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                <strong>Record New Payment</strong>
                </div>
                <div class="card-body">
                {% if sale.balance_due <= 0 %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> No additional payment is needed as this property has been fully paid for.
                    </div>
                {% else %}
                    <form method="post">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="id_amount">Amount (₦)</label>
                            <input type="number" step="0.01" min="0" max="{{ sale.balance_due }}" class="form-control" name="amount" id="id_amount" required>
                            <small class="form-text text-muted">Maximum amount: ₦{{ sale.balance_due|floatformat:2|intcomma }}</small>
                        </div>
                        <div class="form-group">
                            <label for="id_payment_method">Method</label>
                            <select class="form-control" name="payment_method" id="id_payment_method">
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Check">Check</option>
                                <option value="Credit Card">Credit Card</option>
                                <option value="Mobile Money">Mobile Money</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="id_reference">Reference</label>
                            <input type="text" class="form-control" name="reference" id="id_reference">
                        </div>
                        <div class="form-group">
                            <label for="id_notes">Notes</label>
                            <textarea class="form-control" name="notes" id="id_notes" rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Payment</button>
                    </form>
                {% endif %}
                </div>
            </div>
            </div>
        </div>

        </div>
    </div>
</div>
{% endblock %}
